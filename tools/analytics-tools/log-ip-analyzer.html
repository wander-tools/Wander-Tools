<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="/favicon.png" sizes="32x32" type="image/png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline Log File / IP Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; color:#333; transition: background 0.3s, color 0.3s; }
.dark { background:#1a1a1a; color:#f0f0f0; }
header { padding:20px; text-align:center; background:#007bff; color:white; }
.container { padding:20px; max-width:1200px; margin:auto; }
input[type="file"], input, select { margin:5px; padding:5px; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:8px; text-align:left; }
th { cursor:pointer; background:#eee; }
.dark th { background:#333; }
.error { color:red; margin-top:10px; }
.success { color:green; margin-top:10px; }
.btn { padding:8px 12px; margin:5px; cursor:pointer; background:#007bff; color:white; border:none; border-radius:5px; }
.dark .btn { background:#0056b3; }
canvas { margin-top:20px; max-width:100%; }
.summary { margin-top:20px; }
.filters { margin-top:20px; display:flex; flex-wrap:wrap; gap:10px; }
.ip-lookup { margin-top:20px; padding:15px; background:#fff; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.dark .ip-lookup { background:#2a2a2a; }
.ip-result { margin-top:15px; }
.ip-result table { margin-top:10px; }
.loading { color: #007bff; font-style: italic; }
</style>
</head>
<body>
<header>
<h1>Offline Log File / IP Analyzer</h1>
<button class="btn" id="toggleMode">Toggle Dark/Light Mode</button>
</header>
<div class="container">
<input type="file" id="logFile" accept=".log,.txt,.csv">
<button class="btn" id="analyzeBtn">Analyze Log</button>
<button class="btn" id="exportBtn">Export CSV</button>
<div id="error" class="error"></div>

<div class="ip-lookup">
    <h3>IP Lookup Tool</h3>
    <input type="text" id="ipLookupInput" placeholder="Enter IP address (e.g., 192.168.1.1)">
    <button class="btn" id="ipLookupBtn">Lookup IP</button>
    <div id="ipLookupResult" class="ip-result"></div>
</div>

<div class="filters">
<input type="text" id="filterIP" placeholder="Filter by IP">
<select id="filterStatus">
<option value="">All Status</option>
<option value="2">2xx</option>
<option value="3">3xx</option>
<option value="4">4xx</option>
<option value="5">5xx</option>
</select>
<input type="date" id="filterStart">
<input type="date" id="filterEnd">
<input type="text" id="filterKeyword" placeholder="Search keyword in URL">
</div>

<div class="summary" id="summary"></div>

<table id="resultTable">
<thead>
<tr>
<th onclick="sortTable(0)">IP Address</th>
<th onclick="sortTable(1)">Date/Time</th>
<th onclick="sortTable(2)">Method</th>
<th onclick="sortTable(3)">Status</th>
<th onclick="sortTable(4)">URL</th>
<th>Location</th>
</tr>
</thead>
<tbody></tbody>
</table>

<canvas id="ipChart"></canvas>
<canvas id="statusChart"></canvas>
</div>

<script>
// Dark/Light mode
document.getElementById('toggleMode').addEventListener('click', () => {
document.body.classList.toggle('dark');
});

// CSV download
function downloadCSV(rows, filename='log_analysis.csv') {
const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
const blob = new Blob([csv], {type: 'text/csv'});
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
a.click();
URL.revokeObjectURL(url);
}

// Sort table
function sortTable(colIndex) {
const table = document.getElementById("resultTable");
const rows = Array.from(table.rows).slice(1);
const asc = !table.dataset.asc || table.dataset.asc === 'false';
rows.sort((a,b) => a.cells[colIndex].innerText.localeCompare(b.cells[colIndex].innerText));
if (!asc) rows.reverse();
rows.forEach(r => table.tBodies[0].appendChild(r));
table.dataset.asc = asc;
}

// Offline IP geolocation dataset (extended example)
const ipDatabase = {
"192.168.0.1": "Local Network",
"192.168.1.1": "Local Router",
"127.0.0.1": "Localhost",
"8.8.8.8": "Google DNS, USA",
"1.1.1.1": "Cloudflare DNS",
"10.0.0.1": "Local Network Gateway",
"172.16.0.1": "Private Network"
};

// Store all parsed rows
let allRows = [];

// IP Lookup function with fallback
async function lookupIP(ip) {
    const resultDiv = document.getElementById('ipLookupResult');
    resultDiv.innerHTML = '<p class="loading">Looking up IP address...</p>';
    
    try {
        // Try ipapi.co first (no API key needed for limited use)
        const response = await fetch(`https://ipapi.co/${ip}/json/`);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.reason || 'IP lookup failed');
        }
        
        const location = data.city || data.region || data.country_name ? 
            `${data.city || ''}, ${data.region || ''}, ${data.country_name || ''}` : 
            'Unknown location';
            
        resultDiv.innerHTML = `
            <h4>IP Details for ${ip}</h4>
            <table>
                <tr><th>IP Address</th><td>${ip}</td></tr>
                <tr><th>Location</th><td>${location}</td></tr>
                <tr><th>ISP</th><td>${data.org || data.asn || 'Unknown'}</td></tr>
                <tr><th>Country</th><td>${data.country_name || 'N/A'} (${data.country_code || 'N/A'})</td></tr>
                <tr><th>Timezone</th><td>${data.timezone || 'N/A'}</td></tr>
            </table>
            <p class="success">IP lookup successful using ipapi.co</p>
        `;
    } catch (error) {
        // Fallback to offline database
        if (ipDatabase[ip]) {
            resultDiv.innerHTML = `
                <h4>IP Details for ${ip}</h4>
                <table>
                    <tr><th>IP Address</th><td>${ip}</td></tr>
                    <tr><th>Location</th><td>${ipDatabase[ip]}</td></tr>
                    <tr><th>Type</th><td>Local/Private IP Address</td></tr>
                </table>
                <p class="success">IP information retrieved from local database</p>
            `;
        } else {
            resultDiv.innerHTML = `
                <p class="error">Error: ${error.message}</p>
                <p>Note: This could be due to API limitations or a private IP address.</p>
            `;
        }
    }
}

// Filter and display
function applyFilters() {
const tbody = document.querySelector('#resultTable tbody');
tbody.innerHTML = '';

const ipFilter = document.getElementById('filterIP').value.trim();
const statusFilter = document.getElementById('filterStatus').value;
const startDate = document.getElementById('filterStart').value;
const endDate = document.getElementById('filterEnd').value;
const keyword = document.getElementById('filterKeyword').value.trim().toLowerCase();

const filtered = allRows.filter(r => {
const ipMatch = ipFilter ? r[0].includes(ipFilter) : true;
const statusMatch = statusFilter ? r[3].startsWith(statusFilter) : true;
const date = new Date(r[1].split(' ')[0]);
const startMatch = startDate ? date >= new Date(startDate) : true;
const endMatch = endDate ? date <= new Date(endDate) : true;
const keywordMatch = keyword ? r[4].toLowerCase().includes(keyword) : true;
return ipMatch && statusMatch && startMatch && endMatch && keywordMatch;
});

const ipCount = {};
const statusCount = {};

filtered.forEach(row => {
const tr = document.createElement('tr');
if (row[3].startsWith('4') || row[3].startsWith('5')) tr.style.backgroundColor = '#ffdada';
row.forEach(v => { const td = document.createElement('td'); td.innerText = v; tr.appendChild(td); });
tbody.appendChild(tr);

ipCount[row[0]] = (ipCount[row[0]] || 0) + 1;
statusCount[row[3]] = (statusCount[row[3]] || 0) + 1;
});

// Summary top IPs
const topIPs = Object.entries(ipCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
const summaryDiv = document.getElementById('summary');
summaryDiv.innerHTML = `<h3>Top 10 Active IPs:</h3><ul>${topIPs.map(i=>`<li>${i[0]} - ${i[1]} requests</li>`).join('')}</ul>`;

// Charts
const ipLabels = topIPs.map(i=>i[0]);
const ipData = topIPs.map(i=>i[1]);

const statusLabels = Object.keys(statusCount);
const statusData = Object.values(statusCount);

if (window.ipChartInstance) window.ipChartInstance.destroy();
if (window.statusChartInstance) window.statusChartInstance.destroy();

const ipCtx = document.getElementById('ipChart').getContext('2d');
window.ipChartInstance = new Chart(ipCtx, {
type: 'bar',
data: { labels: ipLabels, datasets:[{label:'Requests per IP', data: ipData, backgroundColor:'#007bff'}] },
options: { responsive:true }
});

const statusCtx = document.getElementById('statusChart').getContext('2d');
window.statusChartInstance = new Chart(statusCtx, {
type: 'pie',
data: { labels: statusLabels, datasets:[{label:'Requests per Status', data: statusData, backgroundColor:['#28a745','#ffc107','#dc3545','#6c757d','#17a2b8']} ] },
options: { responsive:true }
});
}

// Analyze log
document.getElementById('analyzeBtn').addEventListener('click', () => {
const fileInput = document.getElementById('logFile');
const errorDiv = document.getElementById('error');
const tbody = document.querySelector('#resultTable tbody');
tbody.innerHTML = '';
errorDiv.innerText = '';

if (!fileInput.files[0]) {
errorDiv.innerText = 'Please select a log file.';
return;
}

const file = fileInput.files[0];
if (!['text/plain','application/octet-stream'].includes(file.type) && !file.name.match(/\.(log|txt|csv)$/)) {
errorDiv.innerText = 'Unsupported file type.';
return;
}

const reader = new FileReader();
reader.onload = (e) => {
const lines = e.target.result.split('\n');
allRows = [];

for (const line of lines) {
if (!line.trim()) continue;
const regex = /(\d{1,3}(?:\.\d{1,3}){3}) - - \[([^\]]+)\] "([A-Z]+) ([^"]+)" (\d{3})/;
const match = line.match(regex);
if (match) {
const ip = match[1];
const datetime = match[2];
const method = match[3];
const url = match[4];
const status = match[5];
const location = ipDatabase[ip] || 'Unknown';
allRows.push([ip, datetime, method, status, url, location]);
}
}

if (allRows.length === 0) errorDiv.innerText = 'No valid log entries found.';
document.getElementById('exportBtn').onclick = () => downloadCSV(allRows);
applyFilters();
};
reader.onerror = () => errorDiv.innerText = 'Error reading file.';
reader.readAsText(file);
});

// IP Lookup button event
document.getElementById('ipLookupBtn').addEventListener('click', () => {
    const ip = document.getElementById('ipLookupInput').value.trim();
    if (!ip) {
        document.getElementById('ipLookupResult').innerHTML = '<p class="error">Please enter an IP address</p>';
        return;
    }
    
    // Basic IP validation
    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipRegex.test(ip)) {
        document.getElementById('ipLookupResult').innerHTML = '<p class="error">Please enter a valid IP address (e.g., 192.168.1.1)</p>';
        return;
    }
    
    lookupIP(ip);
});

// Attach filter events
document.getElementById('filterIP').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('change', applyFilters);
document.getElementById('filterStart').addEventListener('change', applyFilters);
document.getElementById('filterEnd').addEventListener('change', applyFilters);
document.getElementById('filterKeyword').addEventListener('input', applyFilters);
</script>
</body>
</html>
