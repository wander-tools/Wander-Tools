<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wander Tools - Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f6f7fb; color: #212529; }
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: #fff; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); padding: 24px; }
        .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .header i { font-size: 28px; color: #4361ee; }
        .grid { display: grid; grid-template-columns: 280px 1fr; gap: 24px; align-items: start; }
        .avatar-wrap { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .avatar { width: 200px; height: 200px; border-radius: 50%; background: #eef1ff; border: 2px solid #e5e8ff; object-fit: cover; }
        .hint { font-size: 12px; color: #666; text-align: center; }
        .field { display: flex; flex-direction: column; gap: 6px; }
        .field label { font-weight: 600; color: #333; }
        .field input { padding: 12px 14px; border: 1px solid #e5e8ff; border-radius: 8px; font-size: 15px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .uid-box { display: flex; gap: 8px; align-items: center; }
        .uid { background: #f2f4ff; border: 1px solid #e5e8ff; padding: 10px 12px; border-radius: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #4361ee; color: #fff; }
        .btn-secondary { background: #e9ecef; color: #212529; }
        .btn-danger { background: #e53935; color: #fff; }
        .msg { margin-top: 12px; padding: 10px; border-radius: 8px; display: none; }
        .msg.success { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .msg.error { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }
        @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }
        .loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <link rel="icon" href="favicon.png" sizes="32x32" type="image/png">
    <meta name="robots" content="noindex, nofollow">
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <i class="fas fa-user-circle"></i>
                <h2>Your Profile</h2>
            </div>
            <div id="profileContent" style="display:none;">
                <div class="grid">
                    <div class="avatar-wrap">
                        <img id="avatarImg" class="avatar" alt="Profile picture">
                        <input type="file" id="avatarInput" accept="image/*">
                        <div class="hint">Upload a square image for best results</div>
                        <button class="btn btn-secondary" id="uploadBtn"><i class="fas fa-upload"></i> Upload Photo</button>
                    </div>
                    <div>
                        <div class="row">
                            <div class="field">
                                <label for="nameInput">Full Name</label>
                                <input type="text" id="nameInput" placeholder="Your name">
                            </div>
                            <div class="field">
                                <label for="emailInput">Email</label>
                                <input type="email" id="emailInput" placeholder="your@email.com">
                            </div>
                        </div>
                        <div class="field" style="margin-top: 12px;">
                            <label>UID (read-only)</label>
                            <div class="uid-box">
                                <div id="uidText" class="uid"></div>
                                <button class="btn btn-secondary" id="copyUid"><i class="fas fa-copy"></i> Copy</button>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary" id="editProfile"><i class="fas fa-edit"></i> Edit Profile</button>
                            <button class="btn btn-primary" id="saveProfile"><i class="fas fa-save"></i> Save Changes</button>
                            <button class="btn btn-secondary" id="goHome"><i class="fas fa-home"></i> Home</button>
                            <button class="btn btn-danger" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
                        </div>
                        <div id="infoMsg" class="msg"></div>
                    </div>
                </div>
            </div>
            <div id="notSignedIn" style="padding: 10px;">
                <p>You are not signed in.</p>
                <div class="actions">
                    <a class="btn btn-primary" href="index.html">Open Home</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBCIRviVtANQrb72IZzyNlQMuCzsIATP7k",
            authDomain: "wander-tools.firebaseapp.com",
            projectId: "wander-tools",
            storageBucket: "wander-tools.firebasestorage.app",
            messagingSenderId: "911828766491",
            appId: "1:911828766491:web:e38541bd54996adea5cdbe",
            measurementId: "G-GY19ZGWP4K"
        };
        if (firebase.apps && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else if (!firebase.apps) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const profileContent = document.getElementById('profileContent');
        const notSignedIn = document.getElementById('notSignedIn');
        const avatarImg = document.getElementById('avatarImg');
        const avatarInput = document.getElementById('avatarInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const nameInput = document.getElementById('nameInput');
        const emailInput = document.getElementById('emailInput');
        const uidText = document.getElementById('uidText');
        const copyUid = document.getElementById('copyUid');
        const infoMsg = document.getElementById('infoMsg');
        const goHome = document.getElementById('goHome');
        const logout = document.getElementById('logout');
        const editProfileBtn = document.getElementById('editProfile');
        const saveProfileBtn = document.getElementById('saveProfile');
        let isEditing = false;

        auth.onAuthStateChanged((user) => {
            if (user) {
                notSignedIn.style.display = 'none';
                profileContent.style.display = 'block';
                avatarImg.src = user.photoURL || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%" height="100%" fill="%23eef1ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23666" font-family="Arial" font-size="22">No Photo</text></svg>';
                nameInput.value = user.displayName || (user.email ? user.email.split('@')[0] : '');
                emailInput.value = user.email || '';
                uidText.textContent = user.uid;
                setEditing(false);
            } else {
                profileContent.style.display = 'none';
                notSignedIn.style.display = 'block';
            }
        });

        goHome.addEventListener('click', () => { window.location.href = 'index.html'; });
        logout.addEventListener('click', async () => { await auth.signOut(); window.location.href = 'index.html'; });

        function showMsg(text, type) {
            infoMsg.textContent = text;
            infoMsg.className = 'msg ' + (type || 'success');
            infoMsg.style.display = 'block';
            setTimeout(() => { infoMsg.style.display = 'none'; }, 4000);
        }

        copyUid.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(uidText.textContent || ''); showMsg('UID copied', 'success'); } catch(e) { showMsg('Could not copy UID', 'error'); }
        });

        uploadBtn.addEventListener('click', async () => {
            const file = avatarInput.files && avatarInput.files[0];
            const user = auth.currentUser;
            if (!user) return;
            if (!file) { showMsg('Please choose an image first', 'error'); return; }
            try {
                const ref = storage.ref().child(`avatars/${user.uid}.jpg`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                await user.updateProfile({ photoURL: url });
                avatarImg.src = url;
                try { await db.collection('users').doc(user.uid).set({ photoURL: url }, { merge: true }); } catch(e) {}
                showMsg('Profile photo updated');
            } catch (err) {
                showMsg('Photo upload failed', 'error');
                console.error(err);
            }
        });

        function setEditing(enable) {
            isEditing = !!enable;
            nameInput.disabled = !enable;
            emailInput.disabled = !enable;
            avatarInput.disabled = !enable;
            uploadBtn.disabled = !enable;
            saveProfileBtn.disabled = !enable;
            editProfileBtn.textContent = enable ? 'Cancel Edit' : 'Edit Profile';
            editProfileBtn.innerHTML = enable ? '<i class="fas fa-times"></i> Cancel Edit' : '<i class="fas fa-edit"></i> Edit Profile';
        }

        editProfileBtn.addEventListener('click', () => {
            const user = auth.currentUser;
            if (!user) return;
            if (isEditing) {
                // reset to current user data and disable editing
                nameInput.value = user.displayName || (user.email ? user.email.split('@')[0] : '');
                emailInput.value = user.email || '';
                setEditing(false);
            } else {
                setEditing(true);
                nameInput.focus();
            }
        });

        saveProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const newName = nameInput.value.trim();
            const newEmail = emailInput.value.trim();
            try {
                // show loading state
                saveProfileBtn.disabled = true;
                editProfileBtn.disabled = true;
                const originalSaveHtml = saveProfileBtn.innerHTML;
                saveProfileBtn.innerHTML = '<span class="loader"></span> Saving...';
                if (newName && newName !== user.displayName) {
                    await user.updateProfile({ displayName: newName });
                }
                if (newEmail && newEmail !== user.email) {
                    try {
                        await user.updateEmail(newEmail);
                    } catch (e) {
                        if (e && e.code === 'auth/requires-recent-login') {
                            const pwd = prompt('Please enter your password to confirm email change:');
                            if (pwd) {
                                const cred = firebase.auth.EmailAuthProvider.credential(user.email || '', pwd);
                                await user.reauthenticateWithCredential(cred);
                                await user.updateEmail(newEmail);
                            } else {
                                throw e;
                            }
                        } else { throw e; }
                    }
                }
                try { await db.collection('users').doc(user.uid).set({ name: newName, email: newEmail }, { merge: true }); } catch(e) {}
                showMsg('Profile updated');
                setEditing(false);
                saveProfileBtn.innerHTML = originalSaveHtml;
                editProfileBtn.disabled = false;
            } catch (err) {
                console.error(err);
                showMsg('Update failed: ' + (err.message || 'Unknown error'), 'error');
            } finally {
                saveProfileBtn.disabled = false;
                editProfileBtn.disabled = false;
                if (saveProfileBtn.innerHTML.indexOf('Saving...') !== -1) {
                    saveProfileBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            }
        });
    </script>
</body>
</html>

