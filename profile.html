<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wander Tools - Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: linear-gradient(135deg, #f7f9ff 0%, #eef2ff 100%); color: #212529; }
        .container { max-width: 1000px; margin: 28px auto 48px; padding: 0 20px; }
        .card { background: #fff; border-radius: 16px; box-shadow: 0 18px 45px rgba(0,0,0,0.10); padding: 24px; border: 1px solid rgba(67,97,238,0.08); }
        .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .header i { font-size: 28px; color: #4361ee; }
        .grid { display: grid; grid-template-columns: 300px 1fr; gap: 28px; align-items: start; }
        .grid > * { min-width: 0; }
        .avatar-wrap { display: flex; flex-direction: column; align-items: center; gap: 12px; position: relative; }
        .avatar { width: 200px; height: 200px; border-radius: 50%; background: #eef1ff; border: 3px solid #e5e8ff; object-fit: cover; box-shadow: 0 12px 28px rgba(67,97,238,0.18); }
        .hint { font-size: 12px; color: #666; text-align: center; }
        .field { display: flex; flex-direction: column; gap: 6px; }
        .field label { font-weight: 600; color: #333; }
        .field input { width: 100%; padding: 12px 14px; border: 1px solid #e5e8ff; border-radius: 10px; font-size: 15px; background: #fbfcff; color:#212529; transition: background .2s ease, border-color .2s ease, box-shadow .2s ease; }
        .field input:disabled { background:#f1f3ff; color:#64748b; border-color:#e5e8ff; }
        .field input:not(:disabled) { background:#ffffff; color:#1f2937; border-color:#cfd6ff; }
        .field input:focus { outline: none; border-color:#4a6bff; box-shadow: 0 0 0 3px rgba(74,107,255,0.15); background:#ffffff; }
        .field input::placeholder { color:#9aa5b1; }
        [data-theme="dark"] .field input { background:#1f2937; color:#e5e7eb; border-color:#3b4252; }
        [data-theme="dark"] .field input:disabled { background:#111827; color:#9ca3af; border-color:#374151; }
        [data-theme="dark"] .field input:not(:disabled) { background:#111827; color:#e5e7eb; border-color:#475569; }
        [data-theme="dark"] .field input:focus { border-color:#60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.25); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .uid-box { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .uid { background: #f2f4ff; border: 1px solid #e5e8ff; padding: 10px 12px; border-radius: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 11px 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; letter-spacing: .2px; box-shadow: 0 8px 18px rgba(67,97,238,0.12); transition: transform .15s ease, box-shadow .25s ease, background .2s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 14px 28px rgba(67,97,238,0.18); }
        .btn:active { transform: translateY(0); box-shadow: 0 8px 18px rgba(67,97,238,0.12); }
        .btn-primary { background: linear-gradient(90deg, #4776E6 0%, #8E54E9 100%); color: #fff; }
        .btn-secondary { background: #eef1f6; color: #2b2f36; }
        .btn-danger { background: #e53935; color: #fff; }
        .msg { margin-top: 12px; padding: 10px; border-radius: 8px; display: none; }
        .msg.success { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .msg.error { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }
        @media (max-width: 840px) { .grid { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .row { grid-template-columns: 1fr; } .avatar { width: 150px; height: 150px; } }
        .loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Hero profile banner */
        .profile-hero { position: relative; border-radius: 18px; overflow: hidden; background: radial-gradient(1200px 400px at -10% -10%, rgba(67,97,238,.22), transparent), radial-gradient(1200px 400px at 110% 110%, rgba(142,84,233,.22), transparent), linear-gradient(135deg, #4a6bff 0%, #7c4dff 100%); color: #fff; padding: 30px 22px 80px; box-shadow: 0 16px 40px rgba(74,107,255,.25); border: 1px solid rgba(255,255,255,0.15); }
        .profile-hero .hero-inner { display: flex; align-items: center; gap: 18px; }
        .hero-avatar { width: 78px; height: 78px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.65); object-fit: cover; box-shadow: 0 8px 22px rgba(0,0,0,0.25); background:#fff; }
        .hero-text h2 { margin: 0; font-size: 1.5rem; }
        .hero-text p { margin: 4px 0 0; opacity: .9; }
        .profile-stats { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; position: absolute; left: 22px; right: 22px; bottom: 18px; }
        .stat-card { background: rgba(255,255,255,0.14); border: 1px solid rgba(255,255,255,0.25); border-radius: 14px; padding: 10px 12px; text-align: center; backdrop-filter: blur(6px); }
        .stat-card .label { font-size: 12px; opacity: .9; }
        .stat-card .value { font-size: 18px; font-weight: 800; }
        @media (max-width: 520px){ .profile-stats { grid-template-columns: 1fr; } }

        /* Responsive enhancements */
        @media (max-width: 1080px){ .container { max-width: 940px; } }
        @media (max-width: 1024px){ .container { max-width: 900px; } .grid { grid-template-columns: 260px 1fr; } }
        @media (max-width: 900px){
            .container { max-width: 820px; }
            .card { padding: 20px; }
        }
        @media (max-width: 880px){ .grid { grid-template-columns: 1fr; } }
        @media (max-width: 840px){ .container { margin-top: 18px; } .profile-hero { padding: 22px 16px 72px; } .hero-text h2 { font-size: 1.3rem; } .profile-stats { left: 16px; right: 16px; gap: 8px; } }
        @media (max-width: 768px){ .row { grid-template-columns: 1fr; } }
        @media (max-width: 680px){ .card { border-radius: 14px; } .row { gap: 12px; } .field input { font-size: 16px; padding: 12px; } /* avoid iOS zoom */ .avatar { width: 170px; height: 170px; } .actions { gap: 8px; } .actions .btn { flex: 1 1 48%; } }
        @media (max-width: 560px){
            .container { padding: 0 12px; }
            .card { padding: 16px; }
            .profile-hero { padding: 18px 14px 18px; margin-bottom: 16px; }
            /* Move stats into normal flow on small screens to avoid overlap */
            .profile-stats { position: static; left: auto; right: auto; bottom: auto; margin-top: 12px; grid-template-columns: 1fr; }
            .hero-avatar { width: 64px; height: 64px; }
            .hero-text h2 { font-size: 1.15rem; }
            .hero-text p { font-size: .9rem; }
            .stat-card .value { font-size: 16px; }
            .stat-card .label { font-size: 11px; }
            .actions { flex-direction: column; }
            .actions .btn { width: 100%; flex: 1 1 auto; }
        }
        @media (max-width: 420px){
            .avatar { width: 140px; height: 140px; }
            .uid { font-size: 13px; }
            .home-prof-btn { padding: 8px 10px; }
        }
    </style>
    <link rel="icon" href="favicon.png" sizes="32x32" type="image/png">
    <meta name="robots" content="noindex, nofollow">
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <div class="container">
        <div class="profile-hero" id="profileHero" style="display:none;">
            <div class="hero-inner">
                <img id="heroAvatar" class="hero-avatar" alt="Avatar">
                <div class="hero-text">
                    <h2 id="heroName">Welcome</h2>
                    <p id="heroEmail"></p>
                </div>
            </div>
            <div class="profile-stats">
                <div class="stat-card"><div class="label">Member Since</div><div class="value" id="heroSince">—</div></div>
                <div class="stat-card"><div class="label">Tools Used</div><div class="value" id="heroTools">—</div></div>
                <div class="stat-card"><div class="label">Last Active</div><div class="value" id="heroActive">—</div></div>
            </div>
        </div>
        <div class="card">
            <div class="header">
                <i class="fas fa-user-circle"></i>
                <h2>Your Profile</h2>
            </div>
            <div id="profileContent" style="display:none;">
                <div class="grid">
                    <div class="avatar-wrap">
                        <img id="avatarImg" class="avatar" alt="Profile picture">
                        <input type="file" id="avatarInput" accept="image/*">
                        <div class="hint">Upload a square image for best results</div>
                        <button class="btn btn-secondary" id="uploadBtn"><i class="fas fa-upload"></i> Upload Photo</button>
                    </div>
                    <div>
                        <div class="row">
                            <div class="field">
                                <label for="nameInput">Full Name</label>
                                <input type="text" id="nameInput" placeholder="Your name">
                            </div>
                            <div class="field">
                                <label for="emailInput">Email</label>
                                <input type="email" id="emailInput" placeholder="your@email.com">
                            </div>
                        </div>
                        <div class="field" style="margin-top: 12px;">
                            <label>UID (read-only)</label>
                            <div class="uid-box">
                                <div id="uidText" class="uid"></div>
                                <button class="btn btn-secondary" id="copyUid"><i class="fas fa-copy"></i> Copy</button>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary" id="editProfile"><i class="fas fa-edit"></i> Edit Profile</button>
                            <button class="btn btn-primary" id="saveProfile"><i class="fas fa-save"></i> Save Changes</button>
                            <button class="btn btn-secondary" id="goHome"><i class="fas fa-home"></i> Home</button>
                            <button class="btn btn-danger" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
                        </div>
                        <div id="infoMsg" class="msg"></div>
                    </div>
                </div>
            </div>
            <div id="notSignedIn" style="padding: 10px;">
                <p>You are not signed in.</p>
                <div class="actions">
                    <a class="btn btn-primary" href="index.html">Open Home</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBCIRviVtANQrb72IZzyNlQMuCzsIATP7k",
            authDomain: "wander-tools.firebaseapp.com",
            projectId: "wander-tools",
            storageBucket: "wander-tools.firebasestorage.app",
            messagingSenderId: "911828766491",
            appId: "1:911828766491:web:e38541bd54996adea5cdbe",
            measurementId: "G-GY19ZGWP4K"
        };
        if (!firebase.apps || (firebase.apps && !firebase.apps.length)) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Ensure auth persistence is LOCAL so login state is preserved across pages
        try { auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{}); } catch(_) {}

        const profileContent = document.getElementById('profileContent');
        const profileHero = document.getElementById('profileHero');
        const heroAvatar = document.getElementById('heroAvatar');
        const heroName = document.getElementById('heroName');
        const heroEmail = document.getElementById('heroEmail');
        const heroSince = document.getElementById('heroSince');
        const heroTools = document.getElementById('heroTools');
        const heroActive = document.getElementById('heroActive');
        const notSignedIn = document.getElementById('notSignedIn');
        const avatarImg = document.getElementById('avatarImg');
        const avatarInput = document.getElementById('avatarInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const nameInput = document.getElementById('nameInput');
        const emailInput = document.getElementById('emailInput');
        const uidText = document.getElementById('uidText');
        const copyUid = document.getElementById('copyUid');
        const infoMsg = document.getElementById('infoMsg');
        const goHome = document.getElementById('goHome');
        const logout = document.getElementById('logout');
        const editProfileBtn = document.getElementById('editProfile');
        const saveProfileBtn = document.getElementById('saveProfile');
        let isEditing = false;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                notSignedIn.style.display = 'none';
                profileContent.style.display = 'block';
                profileHero.style.display = 'block';
                avatarImg.src = user.photoURL || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%" height="100%" fill="%23eef1ff"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%23666" font-family="Arial" font-size="22">No Photo</text></svg>';
                heroAvatar.src = user.photoURL || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="100%" height="100%" fill="%23ffffff"/></svg>';
                nameInput.value = user.displayName || (user.email ? user.email.split('@')[0] : '');
                emailInput.value = user.email || '';
                uidText.textContent = user.uid;
                heroName.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
                heroEmail.textContent = user.email || '';
                try {
                    const meta = await db.collection('users').doc(user.uid).get();
                    const d = meta.exists ? meta.data() : {};
                    heroSince.textContent = (d.createdAt ? new Date(d.createdAt).toLocaleDateString() : (user.metadata?.creationTime ? new Date(user.metadata.creationTime).toLocaleDateString() : '—'));
                    heroTools.textContent = d.toolsUsed || '—';
                    heroActive.textContent = (user.metadata?.lastSignInTime ? new Date(user.metadata.lastSignInTime).toLocaleDateString() : '—');
                } catch(_) {}
                setEditing(false);
            } else {
                profileContent.style.display = 'none';
                profileHero.style.display = 'none';
                notSignedIn.style.display = 'block';
            }
        });

        goHome.addEventListener('click', () => { window.location.href = 'index.html'; });
        logout.addEventListener('click', async () => { await auth.signOut(); window.location.href = 'index.html'; });

        function showMsg(text, type) {
            infoMsg.textContent = text;
            infoMsg.className = 'msg ' + (type || 'success');
            infoMsg.style.display = 'block';
            setTimeout(() => { infoMsg.style.display = 'none'; }, 4000);
        }

        copyUid.addEventListener('click', async () => {
            try { await navigator.clipboard.writeText(uidText.textContent || ''); showMsg('UID copied', 'success'); } catch(e) { showMsg('Could not copy UID', 'error'); }
        });

        uploadBtn.addEventListener('click', async () => {
            const file = avatarInput.files && avatarInput.files[0];
            const user = auth.currentUser;
            if (!user) return;
            if (!file) { showMsg('Please choose an image first', 'error'); return; }
            try {
                const ref = storage.ref().child(`avatars/${user.uid}.jpg`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                await user.updateProfile({ photoURL: url });
                avatarImg.src = url;
                try { await db.collection('users').doc(user.uid).set({ photoURL: url }, { merge: true }); } catch(e) {}
                showMsg('Profile photo updated');
            } catch (err) {
                showMsg('Photo upload failed', 'error');
                console.error(err);
            }
        });

        function setEditing(enable) {
            isEditing = !!enable;
            nameInput.disabled = !enable;
            emailInput.disabled = !enable;
            avatarInput.disabled = !enable;
            uploadBtn.disabled = !enable;
            saveProfileBtn.disabled = !enable;
            editProfileBtn.textContent = enable ? 'Cancel Edit' : 'Edit Profile';
            editProfileBtn.innerHTML = enable ? '<i class="fas fa-times"></i> Cancel Edit' : '<i class="fas fa-edit"></i> Edit Profile';
        }

        editProfileBtn.addEventListener('click', () => {
            const user = auth.currentUser;
            if (!user) return;
            if (isEditing) {
                // reset to current user data and disable editing
                nameInput.value = user.displayName || (user.email ? user.email.split('@')[0] : '');
                emailInput.value = user.email || '';
                setEditing(false);
            } else {
                setEditing(true);
                nameInput.focus();
            }
        });

        saveProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const newName = nameInput.value.trim();
            const newEmail = emailInput.value.trim();
            try {
                // show loading state
                saveProfileBtn.disabled = true;
                editProfileBtn.disabled = true;
                const originalSaveHtml = saveProfileBtn.innerHTML;
                saveProfileBtn.innerHTML = '<span class="loader"></span> Saving...';
                if (newName && newName !== user.displayName) {
                    await user.updateProfile({ displayName: newName });
                }
                if (newEmail && newEmail !== user.email) {
                    try {
                        await user.updateEmail(newEmail);
                    } catch (e) {
                        if (e && e.code === 'auth/requires-recent-login') {
                            const pwd = prompt('Please enter your password to confirm email change:');
                            if (pwd) {
                                const cred = firebase.auth.EmailAuthProvider.credential(user.email || '', pwd);
                                await user.reauthenticateWithCredential(cred);
                                await user.updateEmail(newEmail);
                            } else {
                                throw e;
                            }
                        } else { throw e; }
                    }
                }
                try { await db.collection('users').doc(user.uid).set({ name: newName, email: newEmail }, { merge: true }); } catch(e) {}
                showMsg('Profile updated');
                setEditing(false);
                saveProfileBtn.innerHTML = originalSaveHtml;
                editProfileBtn.disabled = false;
            } catch (err) {
                console.error(err);
                showMsg('Update failed: ' + (err.message || 'Unknown error'), 'error');
            } finally {
                saveProfileBtn.disabled = false;
                editProfileBtn.disabled = false;
                if (saveProfileBtn.innerHTML.indexOf('Saving...') !== -1) {
                    saveProfileBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            }
        });
    </script>
</body>
</html>

